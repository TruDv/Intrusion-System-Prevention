// --- Start of UPDATED <script> block ---

<script>
    // --- Core Variables ---
    const API_BASE_URL = ''; // Uses relative path (same origin as HTML)
    let currentToken = null; // Stores the JWT string in "Bearer {token}" format for easy use
    let currentUserRole = null;
    let currentUsername = null; 

    // --- Utility Functions ---

    function setServerStatus(isOk) {
        const statusBox = document.getElementById('server-status');
        statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
        statusBox.classList.add(isOk ? 'bg-green-100' : 'bg-red-100', isOk ? 'text-green-800' : 'text-red-800');
        statusBox.textContent = isOk ? '‚úÖ Server Status: Running (Enhanced IPS Backend)' : '‚ùå Server Status: OFFLINE. Check Python console.';
        statusBox.classList.remove('hidden');
    }
    
    async function checkServerStatus() {
        try {
            const response = await fetch(API_BASE_URL + '/', { method: 'GET' }); 
            setServerStatus(response.ok); 
        } catch (error) {
            setServerStatus(false);
        }
    }

    function showMessage(text, isError = false) {
        const box = document.getElementById('message-box');
        box.innerHTML = text; // Use innerHTML to allow HTML formatting
        box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
        
        if (isError) {
            box.classList.add('bg-red-100', 'text-red-800');
            console.error('API Error:', text);
        } else if (text.includes('MFA REQUIRED') || text.includes('Password successful')) {
            box.classList.add('bg-blue-100', 'text-blue-800');
        } else if (text.includes('WAF Test Successful')) {
             box.classList.add('bg-yellow-100', 'text-yellow-800');
        } else {
            box.classList.add('bg-green-100', 'text-green-800');
        }
        box.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearMessage() {
        document.getElementById('message-box').classList.add('hidden');
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }


    async function apiFetch(endpoint, method, body, token = null) {
        clearMessage();
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            // Send the token exactly as received from the server (e.g., "Bearer {token}")
            headers['Authorization'] = token; 
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            method: method,
            headers: headers,
            body: body ? JSON.stringify(body) : null
        });

        let data = {};
        try {
            data = await response.json();
        } catch (e) {
            throw new Error(`HTTP Error ${response.status}: Server returned non-JSON response.`);
        }
        
        if (!response.ok) {
            throw new Error(data.message || `HTTP Error ${response.status}: ${response.statusText}`);
        }
        return data;
    }

    // --- UI Rendering ---

    function renderLoginUI() {
        currentToken = null;
        currentUserRole = null;
        currentUsername = null;
        document.getElementById('dashboard-container').classList.add('hidden');
        document.getElementById('log-output').textContent = '';
        clearMessage();
        
        document.getElementById('auth-flow-container').innerHTML = `
            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <input type="text" id="login_username" placeholder="Username (e.g., admin, finance, user1)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="username" required>
                <input type="password" id="login_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="current-password" required>
                
                <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
                    Login (Step 1: Get MFA)
                </button>
            </form>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <p class="text-sm text-center text-gray-500 mb-2">New User? Default role is 'user'.</p>
                <button onclick="renderRegisterUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
                    Go to Registration
                </button>
            </div>
        `;
    }

    function renderRegisterUI() {
         document.getElementById('auth-flow-container').innerHTML = `
             <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Register New Account</h2>
             <form id="register-form" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4">
                 <input type="text" id="reg_username" placeholder="New Username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                 <input type="password" id="reg_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                 <p class="text-xs text-gray-500">Note: Role defaults to 'user'.</p>
                 
                 <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
                     Register
                 </button>
             </form>
             <div class="mt-4 pt-4 border-t border-gray-100">
                 <button onclick="renderLoginUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
                     Back to Login
                 </button>
             </div>
         `;
     }

    function renderMFAUI(mfaCode) {
        clearMessage();
        
        // Display the code clearly in the message box 
        showMessage(`
            üîë **MFA REQUIRED!** Your one-time code for **${currentUsername}** is: 
            <span class="font-extrabold text-lg bg-yellow-200 p-1 rounded-md text-red-800">${mfaCode}</span>.
            <br>(For demonstration purposes only: code expires in 5 minutes.)
        `, false);

        document.getElementById('auth-flow-container').innerHTML = `
            <form onsubmit="event.preventDefault(); handleVerifyMFA();" class="space-y-4">
                <h2 class="text-2xl font-bold text-center text-teal-600">MFA Verification (Step 2)</h2>
                <p class="text-sm text-center text-gray-600">Enter the 6-digit code from the message box above.</p>
                <input type="text" id="otp_code" placeholder="MFA Code (e.g., 123456)" class="w-full p-4 border-2 border-teal-300 rounded-lg text-center text-xl tracking-wider focus:ring-teal-500 focus:border-teal-500" maxlength="6" required>
                
                <button type="submit" class="w-full py-3 px-4 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-semibold transition duration-150 shadow-md">
                    Verify MFA (Get JWT)
                </button>
            </form>
        `;
    }

    function renderDashboard() {
        // Redraw Dashboard with updated buttons for the enhanced backend
        document.getElementById('auth-flow-container').innerHTML = ''; 
        document.getElementById('user-username').textContent = currentUsername;
        document.getElementById('user-role').textContent = currentUserRole;
        document.getElementById('dashboard-container').classList.remove('hidden');
        showMessage('Login and MFA successful. JWT issued.', false);
        
        // --- Dashboard Button Update to match Flask Routes/Methods ---
        const dashboardHtml = `
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-green-600">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM9.53 5.47a.75.75 0 0 0-1.06 1.06l3.19 3.19-3.19 3.19a.75.75 0 1 0 1.06 1.06l4.44-4.44a.75.75 0 0 0 0-1.06l-4.44-4.44Z" clip-rule="evenodd" />
                </svg>
                Active Session
            </h2>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700 mb-1">Authenticated User: <span id="user-username" class="font-extrabold text-blue-800">${currentUsername}</span></p>
                <p class="text-sm text-gray-700">Role: <span id="user-role" class="font-bold text-blue-600 uppercase">${currentUserRole}</span></p>
                <p class="text-xs text-gray-500 truncate mt-2">Token Exists (Not Displayed for Security)</p>
            </div>
            
            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Protected Resources (RBAC/WAF/Velocity Test):</h3>
            <div class="space-y-3">
                <button onclick="testProtected('/data/user-profile', 'GET')" class="w-full py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium transition duration-150 shadow-md">
                    Access User Profile (GET)
                </button>
                <button onclick="testProtected('/data/finance-report', 'GET')" class="w-full py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition duration-150 shadow-md">
                    Access Finance Report (GET)
                </button>
                <button onclick="testProtected('/data/admin-report', 'POST', {action: 'Deploy Critical Update'})" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition duration-150 shadow-md">
                    Access Admin Report (POST)
                </button>
                <button onclick="testProtected('/data/high-value-asset', 'GET')" class="w-full py-2 px-4 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white font-medium transition duration-150 shadow-md">
                    Access High-Value Asset (Velocity Test)
                </button>
            </div>

            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Intrusion Prevention Tests:</h3>
            <div class="space-y-3">
                <button onclick="testWafAttack()" class="w-full py-2 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition duration-150 shadow-md">
                    Test WAF Attack (SQL Injection attempt)
                </button>
                <button onclick="fetchLogs()" class="w-full py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-medium transition duration-150 shadow-md">
                    View Security Anomalies (Admin Only)
                </button>
            </div>

            <pre id="log-output" class="mt-3 p-3 h-48 bg-gray-800 text-yellow-400 text-xs overflow-y-scroll rounded-lg border border-gray-700"></pre>

            <button onclick="logout()" class="w-full mt-6 py-2 px-4 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium transition duration-150 shadow-md">
                Logout
            </button>
        `;
        document.getElementById('dashboard-container').innerHTML = dashboardHtml;
        fetchLogs(); 
    }

    // --- API Handlers (SYNCHRONIZED WITH FLASK BACKEND) ---

    async function handleRegister() {
        const username = document.getElementById('reg_username').value;
        const password = document.getElementById('reg_password').value;
        
        try {
            // Note: The backend ignores the 'email' field you had in your original client UI
            const data = await apiFetch('/register', 'POST', { username, password }); 
            showMessage(data.message, false);
            renderLoginUI();
        } catch (error) {
            showMessage(`Registration Error: ${error.message}`, true);
        }
    }

    async function handleLogin() {
        const username = document.getElementById('login_username').value;
        const password = document.getElementById('login_password').value;

        try {
            const data = await apiFetch('/login', 'POST', { username, password });

            // Backend returns 'test_mfa_code' on password success
            if (data.test_mfa_code) {
                currentUsername = username;
                const mfaCode = data.test_mfa_code; 
                showMessage(data.message + '. Code generated.', false);
                renderMFAUI(mfaCode);
            } else {
                showMessage(data.message, false);
            }
        } catch (error) {
            showMessage(`Login Error: ${error.message}`, true);
        }
    }

    async function handleVerifyMFA() {
        // The backend uses a 6-digit number, not a hex code, so we adapt the input.
        const otp_code = document.getElementById('otp_code').value; 

        if (!currentUsername || !otp_code) {
            showMessage('Error: Missing username or MFA code.', true);
            return;
        }

        try {
            const data = await apiFetch('/verify-mfa', 'POST', { username: currentUsername, mfa_code: otp_code });
            
            // Backend returns the full token string like "Bearer {token}"
            currentToken = data.token; 
            
            // DANGER: We decode the UNSIGNED token ONLY to get the role for UI display.
            // Never trust client-side decoding for security logic.
            const tokenParts = currentToken.split(' ')[1].split('.'); 
            const payloadStr = JSON.parse(currentToken.split(' ')[1]).payload;
            currentUserRole = JSON.parse(payloadStr).role;

            renderDashboard();
        } catch (error) {
            showMessage(`MFA Error: ${error.message}`, true);
        }
    }

    async function testProtected(endpoint, method, body = null) {
        if (!currentToken) {
            showMessage('Error: You must be logged in to test protected routes.', true);
            return;
        }

        try {
            const data = await apiFetch(endpoint, method, body, currentToken);
            let message = `${data.message} ${data.report_data ? 'Data: ' + JSON.stringify(data.report_data) : ''} ${data.action_taken ? data.action_taken : ''}`;
            showMessage(message, false);
        } catch (error) {
            // This catches RBAC failures, Velocity Anomalies, and WAF blocks
            showMessage(`Access/Security Check Failed: **${error.message}**`, true);
            fetchLogs(); // Fetch logs to see the CRITICAL/ALERT triggered
        }
    }
    
    // --- NEW FUNCTION TO TEST WAF ---
    async function testWafAttack() {
        const endpoint = '/data/admin-report'; // A protected POST route that checks WAF
        const body = { 
            action: "UPDATE user SET password='hacked' WHERE 1=1 --" 
        };

        if (!currentToken) {
            showMessage('Error: Log in first to test the WAF decorator on protected routes.', true);
            return;
        }

        try {
            const data = await apiFetch(endpoint, 'POST', body, currentToken);
            showMessage(`WAF Attack Test (Unexpected Success): ${data.message}`, true); 
        } catch (error) {
            // We EXPECT this to fail with a 403 and the signature check message
            if (error.message.includes('Malicious signature detected')) {
                showMessage(`‚úÖ WAF Test Successful! Server blocked the request: **${error.message}**`, false);
            } else {
                showMessage(`WAF Test Failed (Different Error): ${error.message}`, true);
            }
            fetchLogs(); 
        }
    }


    async function fetchLogs() {
         if (!currentToken) {
             showMessage('Error: Log in as admin to view anomaly logs.', true);
             return;
         }
         
        // The backend view_anomaly_logs route is limited to the 'admin' role
        if (currentUserRole !== 'admin') {
            showMessage('Error: Only users with the **admin** role can view security logs.', true);
            return;
        }

        try {
            const logData = await apiFetch('/data/log-anomaly', 'GET', null, currentToken);
            const logs = logData.logs;
            const logOutput = document.getElementById('log-output');
            
            if (logs && logs.length > 0) {
                const formattedLogs = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    
                    let color = 'text-green-400';
                    if (log.level === 'WARNING') color = 'text-yellow-400';
                    if (log.level === 'ALERT') color = 'text-orange-400';
                    if (log.level === 'CRITICAL') color = 'text-red-400 font-extrabold';

                    const escapedMessage = escapeHtml(log.message);

                    return `<span class="${color}">[${time} | ${log.level} | ${log.event_type}]</span> ${escapedMessage} (IP: ${log.source_ip})`;
                }).join('\n');
                
                logOutput.innerHTML = formattedLogs;
            } else {
                logOutput.textContent = 'No recent ALERT/CRITICAL log entries found.';
            }
            
            showMessage(logData.message, false);
        } catch (error) {
            showMessage(`Log Fetch Error: ${error.message}`, true);
        }
    }

    function logout() {
        currentToken = null;
        currentUserRole = null;
        currentUsername = null;
        showMessage('Logged out successfully.', false);
        renderLoginUI();
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        checkServerStatus();
        renderLoginUI();
    });

</script>

// --- End of UPDATED <script> block ---