<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>E-IPM Secure Authentication Client</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  body { 
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif; 
Â  Â  Â  Â  Â  Â  background-color: #f0f4f8; 
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card { 
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1), 0 4px 10px -2px rgba(0, 0, 0, 0.04); 
Â  Â  Â  Â  Â  Â  animation: slideIn 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes slideIn {
Â  Â  Â  Â  Â  Â  from { opacity: 0; transform: translateY(-20px); }
Â  Â  Â  Â  Â  Â  to { opacity: 1; transform: translateY(0); }
Â  Â  Â  Â  }
Â  Â  Â  Â  .text-gradient {
Â  Â  Â  Â  Â  Â  background-image: linear-gradient(90deg, #1e3a8a, #3b82f6);
Â  Â  Â  Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="flex flex-col">

Â  Â  <div class="card w-full max-w-lg bg-white p-8 rounded-2xl border-t-8 border-blue-700">
Â  Â  Â  Â  <h1 class="text-4xl font-extrabold text-gradient mb-2 text-center">
Â  Â  Â  Â  Â  Â  Enhanced Intrusion Prevention Model (E-IPM)
Â  Â  Â  Â  </h1>
Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-6 text-center">
Â  Â  Â  Â  Â  Â  MFA & RBAC with Signature-Based Intrusion Prevention
Â  Â  Â  Â  </p>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="server-status" class="text-center text-xs p-2 rounded-lg mb-4 hidden"></div>

Â  Â  Â  Â  <div id="auth-flow-container">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="message-box" class="mt-6 p-4 rounded-lg text-sm transition duration-300 hidden" role="alert"></div>

Â  Â  Â  Â  <div id="dashboard-container" class="mt-8 pt-6 border-t border-gray-200 hidden">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-green-600">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM9.53 5.47a.75.75 0 0 0-1.06 1.06l3.19 3.19-3.19 3.19a.75.75 0 1 0 1.06 1.06l4.44-4.44a.75.75 0 0 0 0-1.06l-4.44-4.44Z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Active Session
Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700 mb-1">Authenticated User: <span id="user-username" class="font-extrabold text-blue-800"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-700">Role: <span id="user-role" class="font-bold text-blue-600 uppercase"></span></p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 truncate mt-2">Token Exists (Not Displayed for Security)</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Protected Resources (RBAC Test):</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="testProtected('/data/admin-report')" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Access Admin Report 
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="testProtected('/data/finance-data')" class="w-full py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Access Finance Data 
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>

                <!-- NEW: Intrusion Simulation Section -->
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold mt-8 mb-3 text-gray-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-pink-600">
                        <path fill-rule="evenodd" d="M10 1a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V1.75A.75.75 0 0 1 10 1ZM3.5 13.5a.75.75 0 0 1 0-1.5h13a.75.75 0 0 1 0 1.5h-13ZM2 15.25a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1-.75-.75ZM2 17a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 17Z" clip-rule="evenodd" />
                    </svg>
                    Signature-Based IPS Test
                </h3>
Â  Â  Â  Â  Â  Â  <button onclick="simulateIntrusion()" class="w-full py-3 px-4 rounded-lg bg-pink-600 hover:bg-pink-700 text-white font-extrabold transition duration-150 shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Simulate SQL Injection Attack (Signature: ' OR 1=1 --)
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Intrusion Prevention Logs:</h3>
Â  Â  Â  Â  Â  Â  <button onclick="fetchLogs()" class="w-full py-2 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  View Security Anomalies (IPS)
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <pre id="log-output" class="mt-3 p-3 h-48 bg-gray-800 text-yellow-400 text-xs overflow-y-scroll rounded-lg border border-gray-700"></pre>

Â  Â  Â  Â  Â  Â  <button onclick="logout()" class="w-full mt-6 py-2 px-4 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Logout
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Core Variables ---
Â  Â  Â  Â  const API_BASE_URL = ''; // Uses relative path (same origin as HTML)
Â  Â  Â  Â  let currentToken = null;
Â  Â  Â  Â  let currentUserRole = null;
Â  Â  Â  Â  let currentUsername = null; 

Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  function setServerStatus(isOk) {
Â  Â  Â  Â  Â  Â  const statusBox = document.getElementById('server-status');
Â  Â  Â  Â  Â  Â  statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
Â  Â  Â  Â  Â  Â  statusBox.classList.add(isOk ? 'bg-green-100' : 'bg-red-100', isOk ? 'text-green-800' : 'text-red-800');
Â  Â  Â  Â  Â  Â  statusBox.textContent = isOk ? 'âœ… Server Status: Running' : 'âŒ Server Status: OFFLINE. Check Render logs or deployment status.';
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  async function checkServerStatus() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Checking the root route (/) is the most reliable way to check if the Flask server is up.
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(API_BASE_URL + '/', { method: 'GET' }); 
Â  Â  Â  Â  Â  Â  Â  Â  setServerStatus(response.ok); 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  setServerStatus(false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMessage(text, isError = false) {
Â  Â  Â  Â  Â  Â  const box = document.getElementById('message-box');
Â  Â  Â  Â  Â  Â  box.innerHTML = text; // Use innerHTML to allow HTML formatting
Â  Â  Â  Â  Â  Â  box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-pink-100', 'text-pink-800');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isError) {
Â  Â  Â  Â  Â  Â  Â  Â  box.classList.add('bg-red-100', 'text-red-800');
Â  Â  Â  Â  Â  Â  Â  Â  console.error('API Error:', text);
Â  Â  Â  Â  Â  Â  } else if (text.includes('MFA REQUIRED')) {
Â  Â  Â  Â  Â  Â  Â  Â  box.classList.add('bg-blue-100', 'text-blue-800');
            // Check for IPS message based on successful simulation
Â  Â  Â  Â  Â  Â  } else if (text.includes('IPS BLOCKED')) {
                box.classList.add('bg-pink-100', 'text-pink-800');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  box.classList.add('bg-green-100', 'text-green-800');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  box.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearMessage() {
Â  Â  Â  Â  Â  Â  document.getElementById('message-box').classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  function escapeHtml(unsafe) {
Â  Â  Â  Â  Â  Â  if (!unsafe) return '';
Â  Â  Â  Â  Â  Â  return unsafe
Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/&/g, "&amp;")
Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/</g, "&lt;")
Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/>/g, "&gt;")
Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/"/g, "&quot;")
Â  Â  Â  Â  Â  Â  Â  Â  Â .replace(/'/g, "&#039;");
Â  Â  Â  Â  }


Â  Â  Â  Â  async function apiFetch(endpoint, method, body, token = null) {
Â  Â  Â  Â  Â  Â  clearMessage();
Â  Â  Â  Â  Â  Â  const headers = { 'Content-Type': 'application/json' };
Â  Â  Â  Â  Â  Â  if (token) {
Â  Â  Â  Â  Â  Â  Â  Â  headers['Authorization'] = `Bearer ${token}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: method,
Â  Â  Â  Â  Â  Â  Â  Â  headers: headers,
Â  Â  Â  Â  Â  Â  Â  Â  body: body ? JSON.stringify(body) : null
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  let data = {};
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  data = await response.json();
Â  Â  Â  Â  Â  Â  } catch (e) {
                // If the response is not JSON, but the status is OK (e.g., a simple string response), handle it.
                if (response.ok) {
                    const text = await response.text();
                    return { message: text, data: {} };
                }
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`HTTP Error ${response.status}: Server returned non-JSON response.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.message || `HTTP Error ${response.status}: ${response.statusText}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return data;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UI Rendering ---

Â  Â  Â  Â  function renderLoginUI() {
Â  Â  Â  Â  Â  Â  currentToken = null;
Â  Â  Â  Â  Â  Â  currentUserRole = null;
Â  Â  Â  Â  Â  Â  currentUsername = null;
Â  Â  Â  Â  Â  Â  document.getElementById('dashboard-container').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('log-output').textContent = '';
Â  Â  Â  Â  Â  Â  clearMessage();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('auth-flow-container').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <form id="login-form" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="login_username" placeholder="Username (e.g., admin, finance)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="username" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="login_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="current-password" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Login
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 pt-4 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-center text-gray-500 mb-2">New User? They will receive role 'Non-admin role'.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="renderRegisterUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Go to Registration
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderRegisterUI() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('auth-flow-container').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Register New Account</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="register-form" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="reg_username" placeholder="New Username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="reg_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="reg_email" placeholder="Email Address" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">Note: Backend currently forces role to 'non-admin'.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Register
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 pt-4 border-t border-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="renderLoginUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Back to Login
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }


Â  Â  Â  Â  function renderMFAUI(mfaCode) {
Â  Â  Â  Â  Â  Â  clearMessage();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Display the code clearly in the message box 
Â  Â  Â  Â  Â  Â  showMessage(`
Â  Â  Â  Â  Â  Â  Â  Â  ğŸ”‘ **MFA REQUIRED!** Your one-time code for **${currentUsername}** is: 
Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-extrabold text-lg bg-yellow-200 p-1 rounded-md text-red-800">${mfaCode}</span>.
Â  Â  Â  Â  Â  Â  Â  Â  <br>(For demonstration purposes only: normally this would be sent privately.)
Â  Â  Â  Â  Â  Â  `, false);

Â  Â  Â  Â  Â  Â  document.getElementById('auth-flow-container').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <form onsubmit="event.preventDefault(); handleVerifyMFA();" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-center text-teal-600">MFA Verification</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-center text-gray-600">Enter the 6-character hex code from the message box above.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="otp_code" placeholder="MFA Code (e.g., A1B2C3)" class="w-full p-4 border-2 border-teal-300 rounded-lg text-center text-xl tracking-wider focus:ring-teal-500 focus:border-teal-500" maxlength="6" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="w-full py-3 px-4 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-semibold transition duration-150 shadow-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Verify MFA (Step 2: Token)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderDashboard() {
Â  Â  Â  Â  Â  Â  document.getElementById('auth-flow-container').innerHTML = ''; 
Â  Â  Â  Â  Â  Â  document.getElementById('user-username').textContent = currentUsername;
Â  Â  Â  Â  Â  Â  document.getElementById('user-role').textContent = currentUserRole;
Â  Â  Â  Â  Â  Â  document.getElementById('dashboard-container').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  showMessage('Login and MFA successful. JWT issued.', false);
Â  Â  Â  Â  Â  Â  fetchLogs(); // Automatically fetch logs on successful login
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- API Handlers ---

Â  Â  Â  Â  async function handleRegister() {
Â  Â  Â  Â  Â  Â  const username = document.getElementById('reg_username').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('reg_password').value;
Â  Â  Â  Â  Â  Â  const email = document.getElementById('reg_email').value;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = await apiFetch('/register', 'POST', { username, password, email, role: 'user' }); 
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(data.message, false);
Â  Â  Â  Â  Â  Â  Â  Â  renderLoginUI();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Registration Error: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleLogin() {
Â  Â  Â  Â  Â  Â  const username = document.getElementById('login_username').value;
Â  Â  Â  Â  Â  Â  const password = document.getElementById('login_password').value;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = await apiFetch('/login', 'POST', { username, password });

Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === 'pending_mfa') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUsername = data.username;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mfaCode = data.mfa_code_for_demo; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderMFAUI(mfaCode);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage(data.message, false);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Login Error: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleVerifyMFA() {
Â  Â  Â  Â  Â  Â  const otp_code = document.getElementById('otp_code').value.toUpperCase();

Â  Â  Â  Â  Â  Â  if (!currentUsername || !otp_code) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Error: Missing username or MFA code.', true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = await apiFetch('/verify-mfa', 'POST', { username: currentUsername, otp_code });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  currentToken = data.access_token;
Â  Â  Â  Â  Â  Â  Â  Â  currentUserRole = data.role;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  renderDashboard();
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`MFA Error: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function testProtected(endpoint) {
Â  Â  Â  Â  Â  Â  if (!currentToken) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Error: You must be logged in to test protected routes.', true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = await apiFetch(endpoint, 'GET', null, currentToken);
Â  Â  Â  Â  Â  Â  Â  Â  let message = `${data.message} Data: ${JSON.stringify(data.data)}`;
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(message, false);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`RBAC Check Failed: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

        // NEW FUNCTION: Simulates an intrusion attempt with a malicious payload
        async function simulateIntrusion() {
            if (!currentToken) {
                showMessage('Error: Please log in first before simulating an intrusion.', true);
                return;
            }
            
            const malicious_payload = "' OR 1=1 --"; // A classic SQL Injection signature
            
            try {
                // Send a POST request to a new simulated endpoint with the malicious data
                const data = await apiFetch('/data/simulate-intrusion', 'POST', { query: malicious_payload }, currentToken);

                // The backend should recognize the payload, block it, and return a message indicating the block
                showMessage(`
                    ğŸš¨ **IPS BLOCKED ATTACK!**
                    <br>Request Payload: <span class="font-mono text-xs">${escapeHtml(malicious_payload)}</span>
                    <br>Response: ${data.message || 'Block signal received.'}
                    <br>Refreshing logs...
                `, false);
                
                // Fetch logs immediately to show the new IPS entry
                fetchLogs();

            } catch (error) {
                // The IPS block might result in an HTTP error (e.g., 403 or 400), which is a successful block.
                if (error.message.includes('HTTP Error 403') || error.message.includes('Block signal')) {
                     showMessage(`
                        âœ… **IPS BLOCK CONFIRMED!**
                        <br>The request containing the signature was blocked by the security layer.
                        <br>Error: <span class="font-mono text-xs">${error.message}</span>
                        <br>Refreshing logs to verify...
                    `, false);
                    fetchLogs();
                } else {
                    showMessage(`Intrusion Simulation Error: ${error.message}`, true);
                }
            }
        }


Â  Â  Â  Â  async function fetchLogs() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // NOTE: The backend needs to provide this endpoint and return an array of log objects.
Â  Â  Â  Â  Â  Â  Â  Â  const logs = await apiFetch('/data/log-anomaly', 'GET', null);
Â  Â  Â  Â  Â  Â  Â  Â  const logOutput = document.getElementById('log-output');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (logs && logs.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sort logs by timestamp descending (newest first)
                    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedLogs = logs.map(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const time = new Date(log.timestamp).toLocaleTimeString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let color = 'text-green-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.level === 'WARNING') color = 'text-yellow-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.level === 'CRITICAL' || log.level === 'ALERT') color = 'text-red-400';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Highlight 'IPS' entries specifically
                        if (log.type.includes('IPS')) color = 'text-pink-400 font-extrabold';

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const escapedMessage = escapeHtml(log.message);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<span class="${color}">[${time} | ${log.type}]</span> ${escapedMessage}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('\n');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logOutput.innerHTML = formattedLogs;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logOutput.textContent = 'No security anomaly log entries found yet.';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('Latest security logs retrieved successfully.', false);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage(`Log Fetch Error: ${error.message}`, true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function logout() {
Â  Â  Â  Â  Â  Â  currentToken = null;
Â  Â  Â  Â  Â  Â  currentUserRole = null;
Â  Â  Â  Â  Â  Â  showMessage('Logged out successfully.', false);
Â  Â  Â  Â  Â  Â  renderLoginUI();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  checkServerStatus();
Â  Â  Â  Â  Â  Â  renderLoginUI();
Â  Â  Â  Â  });

Â  Â  </script>
</body>
</html>