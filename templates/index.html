// --- Start of CORRECTED <script> block ---

<script>
    // --- Core Variables ---
    const API_BASE_URL = ''; // Uses relative path (same origin as HTML)
    let currentToken = null; // Stores the JWT string (the actual token, not "Bearer {token}") üêõ FIX: Store only the token
    let currentUserRole = null;
    let currentUsername = null; 

    // --- Utility Functions ---

    function setServerStatus(isOk) {
        const statusBox = document.getElementById('server-status');
        statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
        statusBox.classList.add(isOk ? 'bg-green-100' : 'bg-red-100', isOk ? 'text-green-800' : 'text-red-800');
        statusBox.textContent = isOk ? '‚úÖ Server Status: Running (Enhanced IPS Backend)' : '‚ùå Server Status: OFFLINE. Check Python console.';
        statusBox.classList.remove('hidden');
    }
    
    async function checkServerStatus() {
        try {
            // üêõ FIX: The index route '/' returns an HTML page, not a simple 200 JSON. 
            // We check the log-anomaly route which is public (though restricted by RBAC later). 
            // Or just check '/' which should load the page itself. Let's use '/' since it loads the page.
            const response = await fetch(API_BASE_URL + '/', { method: 'GET' }); 
            setServerStatus(response.ok); 
        } catch (error) {
            setServerStatus(false);
        }
    }

    function showMessage(text, isError = false) {
        const box = document.getElementById('message-box');
        box.innerHTML = text; // Use innerHTML to allow HTML formatting
        box.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800');
        
        if (isError) {
            box.classList.add('bg-red-100', 'text-red-800');
            console.error('API Error:', text);
        } else if (text.includes('MFA REQUIRED') || text.includes('Password correct')) {
            // üêõ FIX: Update condition to match the Flask response message
            box.classList.add('bg-blue-100', 'text-blue-800');
        } else if (text.includes('WAF Test Successful')) {
             box.classList.add('bg-yellow-100', 'text-yellow-800');
        } else {
            box.classList.add('bg-green-100', 'text-green-800');
        }
        box.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearMessage() {
        document.getElementById('message-box').classList.add('hidden');
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }


    async function apiFetch(endpoint, method, body, token = null) {
        clearMessage();
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            // üêõ FIX: Prepend "Bearer " here, as the token variable now only holds the raw token string
            headers['Authorization'] = `Bearer ${token}`; 
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            method: method,
            headers: headers,
            body: body ? JSON.stringify(body) : null
        });

        let data = {};
        try {
            data = await response.json();
        } catch (e) {
            // Catch error if server returns non-JSON (like an HTML error page)
            if (response.status === 200 && response.headers.get('content-type').includes('text/html')) {
                throw new Error(`HTTP Error ${response.status}: Expected JSON, got HTML (Is Flask running?).`);
            }
            throw new Error(`HTTP Error ${response.status}: Server returned non-JSON response. ${e.message}`);
        }
        
        if (!response.ok) {
            throw new Error(data.message || `HTTP Error ${response.status}: ${response.statusText}`);
        }
        return data;
    }

    // --- UI Rendering (No Changes Needed Here) ---

    function renderLoginUI() {
        currentToken = null;
        currentUserRole = null;
        currentUsername = null;
        document.getElementById('dashboard-container').classList.add('hidden');
        document.getElementById('log-output').textContent = '';
        clearMessage();
        
        document.getElementById('auth-flow-container').innerHTML = `
            <form id="login-form" onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <input type="text" id="login_username" placeholder="Username (e.g., admin, finance, user1)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="username" required>
                <input type="password" id="login_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" autocomplete="current-password" required>
                
                <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
                    Login (Step 1: Get MFA)
                </button>
            </form>

            <div class="mt-4 pt-4 border-t border-gray-100">
                <p class="text-sm text-center text-gray-500 mb-2">New User? Default role is 'user'.</p>
                <button onclick="renderRegisterUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
                    Go to Registration
                </button>
            </div>
        `;
    }

    function renderRegisterUI() {
          document.getElementById('auth-flow-container').innerHTML = `
               <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Register New Account</h2>
               <form id="register-form" onsubmit="event.preventDefault(); handleRegister();" class="space-y-4">
                   <input type="text" id="reg_username" placeholder="New Username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                   <input type="password" id="reg_password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                   <input type="email" id="reg_email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required> 
                   <p class="text-xs text-gray-500">Note: Role defaults to 'user'.</p>
                   
                   <button type="submit" class="w-full py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition duration-150 shadow-md">
                        Register
                   </button>
               </form>
               <div class="mt-4 pt-4 border-t border-gray-100">
                   <button onclick="renderLoginUI()" class="w-full py-2 px-4 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold transition duration-150 shadow-sm">
                        Back to Login
                   </button>
               </div>
          `;
     }

    function renderMFAUI(mfaCode) {
        clearMessage();
        
        // Display the code clearly in the message box 
        showMessage(`
            üîë **MFA REQUIRED!** Your one-time code for **${currentUsername}** is: 
            <span class="font-extrabold text-lg bg-yellow-200 p-1 rounded-md text-red-800">${mfaCode}</span>.
            <br>(For demonstration purposes only: code expires in 5 minutes.)
        `, false);

        document.getElementById('auth-flow-container').innerHTML = `
            <form onsubmit="event.preventDefault(); handleVerifyMFA();" class="space-y-4">
                <h2 class="text-2xl font-bold text-center text-teal-600">MFA Verification (Step 2)</h2>
                <p class="text-sm text-center text-gray-600">Enter the 6-digit code from the message box above.</p>
                <input type="text" id="otp_code" placeholder="MFA Code (e.g., 123456)" class="w-full p-4 border-2 border-teal-300 rounded-lg text-center text-xl tracking-wider focus:ring-teal-500 focus:border-teal-500" maxlength="6" required>
                
                <button type="submit" class="w-full py-3 px-4 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-semibold transition duration-150 shadow-md">
                    Verify MFA (Get JWT)
                </button>
            </form>
        `;
    }

    function renderDashboard() {
        // Redraw Dashboard with updated buttons for the enhanced backend
        document.getElementById('auth-flow-container').innerHTML = ''; 
        document.getElementById('user-username').textContent = currentUsername;
        document.getElementById('user-role').textContent = currentUserRole;
        document.getElementById('dashboard-container').classList.remove('hidden');
        showMessage('Login and MFA successful. JWT issued.', false);
        
        // --- Dashboard Button Update to match Flask Routes/Methods ---
        // üêõ FIX: Update protected route names to match your Flask app
        const dashboardHtml = `
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 text-green-600">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM9.53 5.47a.75.75 0 0 0-1.06 1.06l3.19 3.19-3.19 3.19a.75.75 0 1 0 1.06 1.06l4.44-4.44a.75.75 0 0 0 0-1.06l-4.44-4.44Z" clip-rule="evenodd" />
                </svg>
                Active Session
            </h2>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700 mb-1">Authenticated User: <span id="user-username" class="font-extrabold text-blue-800">${currentUsername}</span></p>
                <p class="text-sm text-gray-700">Role: <span id="user-role" class="font-bold text-blue-600 uppercase">${currentUserRole}</span></p>
                <p class="text-xs text-gray-500 truncate mt-2">Token Exists (Not Displayed for Security)</p>
            </div>
            
            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Protected Resources (RBAC/Rate Limit Test):</h3>
            <div class="space-y-3">
                <button onclick="testProtected('/data/admin-report', 'GET')" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium transition duration-150 shadow-md">
                    Access Admin Report (GET) - Admin Only
                </button>
                <button onclick="testProtected('/data/finance-data', 'GET')" class="w-full py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium transition duration-150 shadow-md">
                    Access Finance Data (GET) - Finance/Admin Only
                </button>
                
                <button onclick="testProtected('/data/finance-data', 'GET')" class="w-full py-2 px-4 rounded-lg bg-yellow-600 hover:bg-yellow-700 text-white font-medium transition duration-150 shadow-md">
                    Test Rate Limit (Repeat 5 times)
                </button>
            </div>

            <h3 class="text-lg font-semibold mt-6 mb-3 text-gray-700">Intrusion Prevention Tests:</h3>
            <div class="space-y-3">
                <button onclick="testWafAttack()" class="w-full py-2 px-4 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-medium transition duration-150 shadow-md">
                    Test WAF Attack (SQL Injection attempt on /register)
                </button>
                <button onclick="fetchLogs()" class="w-full py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-700 text-white font-medium transition duration-150 shadow-md">
                    View Security Anomalies (Public Endpoint)
                </button>
            </div>

            <pre id="log-output" class="mt-3 p-3 h-48 bg-gray-800 text-yellow-400 text-xs overflow-y-scroll rounded-lg border border-gray-700"></pre>

            <button onclick="logout()" class="w-full mt-6 py-2 px-4 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium transition duration-150 shadow-md">
                Logout
            </button>
        `;
        document.getElementById('dashboard-container').innerHTML = dashboardHtml;
        fetchLogs(); 
    }

    // --- API Handlers (SYNCHRONIZED WITH FLASK BACKEND) ---

    async function handleRegister() {
        const username = document.getElementById('reg_username').value;
        const password = document.getElementById('reg_password').value;
        const email = document.getElementById('reg_email').value || 'placeholder@example.com'; // üêõ FIX: Email must be included

        try {
            const data = await apiFetch('/register', 'POST', { username, password, email }); 
            showMessage(data.message, false);
            renderLoginUI();
        } catch (error) {
            showMessage(`Registration Error: ${error.message}`, true);
        }
    }

    async function handleLogin() {
        const username = document.getElementById('login_username').value;
        const password = document.getElementById('login_password').value;

        try {
            const data = await apiFetch('/login', 'POST', { username, password });

            // üêõ FIX: Backend sends the code in 'mfa_code_for_demo'
            if (data.mfa_code_for_demo) {
                currentUsername = username;
                const mfaCode = data.mfa_code_for_demo; 
                showMessage(data.message + '. Code generated.', false);
                renderMFAUI(mfaCode);
            } else {
                showMessage(data.message, false);
            }
        } catch (error) {
            showMessage(`Login Error: ${error.message}`, true);
        }
    }

    async function handleVerifyMFA() {
        const otp_code = document.getElementById('otp_code').value; 

        if (!currentUsername || !otp_code) {
            showMessage('Error: Missing username or MFA code.', true);
            return;
        }

        try {
            // üêõ FIX: Backend expects 'otp_code' in the body
            const data = await apiFetch('/verify-mfa', 'POST', { username: currentUsername, otp_code: otp_code });
            
            // üêõ FIX: Backend sends the token in 'access_token' and role in 'role'
            currentToken = data.access_token; 
            currentUserRole = data.role; 

            // NO NEED for client-side token decoding with the corrected backend response.

            renderDashboard();
        } catch (error) {
            showMessage(`MFA Error: ${error.message}`, true);
        }
    }

    async function testProtected(endpoint, method, body = null) {
        if (!currentToken) {
            showMessage('Error: You must be logged in to test protected routes.', true);
            return;
        }

        try {
            const data = await apiFetch(endpoint, method, body, currentToken);
            // üêõ FIX: Check data keys that your Flask backend sends on success
            let message = `${data.message} ${data.data ? 'Data: ' + JSON.stringify(data.data) : ''}`;
            showMessage(message, false);
        } catch (error) {
            // This catches RBAC failures, Velocity Anomalies, and WAF blocks
            showMessage(`Access/Security Check Failed: **${error.message}**`, true);
            fetchLogs(); // Fetch logs to see the CRITICAL/ALERT triggered
        }
    }
    
    // --- NEW FUNCTION TO TEST WAF ---
    async function testWafAttack() {
        // We will test the WAF decorator logic on the public '/register' route 
        // to see if the Flask WAF decorator blocks it based on the malicious payload.
        const endpoint = '/register'; 
        const body = { 
            username: 'sqltest',
            password: 'password',
            email: "hacked@example.com' OR '1'='1" // SQL Injection attempt in email field
        };

        try {
            // This call should fail if WAF is working
            const data = await apiFetch(endpoint, 'POST', body, currentToken);
            showMessage(`WAF Attack Test (Unexpected Success): ${data.message}`, true); 
        } catch (error) {
            // We EXPECT this to fail if the WAF catches the signature in the body
            if (error.message.includes('Malicious signature detected')) {
                // üêõ NOTE: Since the WAF is on a decorator, it's more common to test it on a protected route like /data/admin-report.
                // However, since we don't have a POST body route, we test /register, but this assumes you've added the WAF decorator to /register.
                showMessage(`‚úÖ WAF Test Successful! Server blocked the request: **${error.message}**`, false);
            } else {
                showMessage(`WAF Test Failed (Different Error): ${error.message}`, true);
            }
            fetchLogs(); 
        }
    }


    async function fetchLogs() {
        // üêõ NOTE: Your Flask route /data/log-anomaly does NOT require a token (it's public)
        // and it returns the log list directly, not under a 'logs' key.

        try {
            const logData = await apiFetch('/data/log-anomaly', 'GET', null, null); // üêõ FIX: Removed currentToken
            
            // logData is now the list of logs
            const logs = logData; 
            const logOutput = document.getElementById('log-output');
            
            if (logs && logs.length > 0) {
                const formattedLogs = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    
                    let color = 'text-green-400';
                    if (log.level === 'WARNING') color = 'text-yellow-400';
                    if (log.level === 'ALERT') color = 'text-orange-400';
                    if (log.level === 'CRITICAL') color = 'text-red-400 font-extrabold';

                    const escapedMessage = escapeHtml(log.message);

                    // üêõ FIX: Backend sends log_type, not event_type
                    return `<span class="${color}">[${time} | ${log.level} | ${log.log_type}]</span> ${escapedMessage} (IP: ${log.source_ip})`;
                }).join('\n');
                
                logOutput.innerHTML = formattedLogs;
            } else {
                logOutput.textContent = 'No recent log entries found.';
            }
            
            showMessage('Security logs fetched successfully.', false); // üêõ FIX: Message is not in the response body
        } catch (error) {
            showMessage(`Log Fetch Error: ${error.message}`, true);
        }
    }

    function logout() {
        currentToken = null;
        currentUserRole = null;
        currentUsername = null;
        showMessage('Logged out successfully.', false);
        renderLoginUI();
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        checkServerStatus();
        renderLoginUI();
    });

</script>

// --- End of CORRECTED <script> block ---